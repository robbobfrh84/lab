<!DOCTYPE html><html><head><meta charset="utf-8">
<script src="references/aws-cognito-sdk.min.js"></script>
<script src="references/amazon-cognito-identity.min.js"></script>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.100.0.min.js"></script>
<style>  html { background-color: #ddd } input { width: 150px;} </style>
</head>
  <body>
    <div style="float: left">
      <h2>DynamoDB: Native Auth</h2>
      <h4> &bull; Read/Write access & user info store</h4>
      <textarea id= "textarea" style="font-size: 14px; width:400px; height:500px; display: block;"></textarea>
    </div>
    <div id="loggedIn" style="float: right; display: none;">
      <span id='user'></span>
      <button onclick="logOut()">Log Out</button> <br>
      <button onclick="logOutAll()" style="float: right">Log Out of All devices</button>
    </div>
    <div id="noLogIn" style="float: right; width: 217px;">
      <div style="float: left">
        <input id="userNameIn" type="text" placeholder="...username or email"> <br>
        <input id="passwordIn" type="password" placeholder="...password">
      </div>
      <div> <button style="height: 40px; width: 57px;" onclick="signIn()"> Sign In </button> </div>
      <hr>
      <div style="float: left">
        <input id="email" type="text" placeholder="...email"> <br>
        <input id="userNameUp" type="text" placeholder="...username"> <br>
        <input id="passwordUp" type="password" placeholder="...password">
      </div>
      <div> <button style="height: 58px;" onclick="signUp()">Sign Up</button> </div>
      <hr>
      <div style="float: right; margin: 0px 0px 6px 60px;">
        <div>
          <input id="forgotEmail" placeholder="...username or email">
          <button style="height: 20px; width: 155px; " onclick="forgot()">Forgot Password</button>
        </div>
      </div>
      <hr>
    </div>
    <div id='confirmBox' style="float: right; display: none;">
      <div>
        <input id="verification" placeholder="...enter varification code">
        <button style="height: 20px; width: 55px; " onclick="confirm()">Confirm</button>
      </div>
    </div>
    </div>
  </body>
</html>
<script>

var attributeList = []
var ddb;
var region = 'us-west-2'
var identityPoolId = 'us-west-2:19434e37-7a62-4189-adeb-c1ac26011b45'
var roleArn = 'arn:aws:iam::118070506734:role/Cognito_SignUpPoolAuth_Role'
var table = 'SignUpUserList'
var poolData = {
  UserPoolId : 'us-west-2_lIwEq7e6O', // Your user pool id here
  ClientId : '5pnntp748hi65035ijm4nl7q4f' // Your client id here
}
var userPool = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool(poolData)
var userData = {
    Username : '',
    Pool : userPool
}

var cognitoUser = userPool.getCurrentUser();

window.onload = ()=>{
  authenticateIdentityPool()
}

// DYANO STUFF.......-----------------------------------------------------------
//
start_dynamoDB = ()=>{
  ddb = new AWS.DynamoDB({ apiVersion: '2012-10-08' })
  get_dynamoDB({
    TableName: table,
      Key: {
        'Username': {S: cognitoUser.username },
        'Client_Id': {S: cognitoUser.pool.clientId},
      }
    },
    (Userdata)=>{ // callback
      if (Object.keys(Userdata).length === 0) { // if user not in table, add 'em.
        let email = ''
        for (const a of cognitoUser.attributes) { if (a.Name === 'email') email = a.Value }
        put_dynamoDB({
          TableName: table,
          Item: {
            'Username': {S: cognitoUser.username },
            'Client_Id': {S: cognitoUser.pool.clientId},
            'Email': {S: email},
            'User_Pool_Id': {S: cognitoUser.pool.userPoolId},
          }
        })
        console.log('User Added to table')
      } else { console.log('User Has been added to table already!')}
    }
  )
  testy()
}

testy = ()=>{


}

get_dynamoDB = (params, callback)=>{
  ddb.getItem(params, (err, data)=>{
    if (err) { console.log("Error", err)
    } else {
      document.getElementById('textarea').innerHTML = JSON.stringify(data, null, 2)
      callback(data)
    }
  })
}

put_dynamoDB = (params)=>{
  ddb.putItem(params, (err, data)=>{
    if (err) { console.log("Error", err)
    } else { console.log("Success", data)
      document.getElementById('textarea').innerHTML = JSON.stringify(params, null, 2)
    }
  })
}
//
// DYANO STUFF.......-----------------------------------------------------------

authenticateIdentityPool = (retry)=>{
  if (cognitoUser != null) { //Check if a user is already signed in
    cognitoUser.getSession(function(err, result) {
      if (result) {
        AWS.config.region = 'us-west-2'
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
          IdentityPoolId: identityPoolId,
          Logins: {
              ['cognito-idp.'+region+'.amazonaws.com/'+poolData.UserPoolId]: result.getIdToken().getJwtToken()
          },
          RoleArn: roleArn
        })
      }
    })
    AWS.config.credentials.refresh((error) => {
      if (error) {
        console.error('error, retry: ', error, retry)
        if (!retry) authenticateIdentityPool()
      } else {
        console.log('Successfully logged!')
        start_dynamoDB()
      }
    })
    user.innerHTML = 'You are now logged in as: '+cognitoUser.username
    loggedIn.style.display = ''; noLogIn.style.display = 'none'
    getUserAttributes()
  }
}

signUp = ()=>{
  const dataEmail = { Name : 'email', Value : email.value }
  const attributeEmail = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserAttribute(dataEmail)
  attributeList.push(attributeEmail)
  userPool.signUp(userNameUp.value, passwordUp.value, attributeList, null, function(err, result){
    if (err) { textarea.innerHTML = err; return }
    cognitoUser = result.user
    textarea.innerHTML = 'SUCCESS! \nUsername is: ' + cognitoUser.getUsername() + '\nEmail is: ' + dataEmail.Value + '\nCheck your email to conferm sign up. \n\n  -> Enter Code and press [ Confirm ] to complete'
    confirmBox.style.display = ''; noLogIn.style.display = 'none'
  })
  email.value = ''; userNameUp.value = ''; passwordUp.value = ''
}

confirm = ()=>{
  cognitoUser.confirmRegistration(verification.value, true, function(err, result) {
    if (err) { textarea.innerHTML = err; return }
    confirmBox.style.display = 'none'; loggedIn.style.display = ''
    user.innerHTML = 'You are now logged in as: '+cognitoUser.username
    textarea.innerHTML = JSON.stringify(cognitoUser, null, 2)
  })
}

signIn = ()=>{
  const authenticationData = { Username : userNameIn.value, Password : passwordIn.value, }
  userData.Username = userNameIn.value
  const authenticationDetails = new AWSCognito.CognitoIdentityServiceProvider.AuthenticationDetails(authenticationData)
  console.log('userData: ',userData)
  cognitoUser = new AWSCognito.CognitoIdentityServiceProvider.CognitoUser(userData);
  cognitoUser.authenticateUser(authenticationDetails, {
    onSuccess: function (result) {
      authenticateIdentityPool(result)
    },
    onFailure: function(err) {
      textarea.innerHTML = err
      if (err = 'Error: User is not confirmed.') {
        textarea.innerHTML = 'You are successfully signed up. However you still need to get your confirmation code from your email and -> Enter Code and press [ Confirm ] to complete'
        confirmBox.style.display = ''; noLogIn.style.display = 'none'
      }
    },
    mfaRequired: function(codeDeliveryDetails) {
      var verificationCode = prompt('Please input verification code' ,'')
      cognitoUser.sendMFACode(verificationCode, this)
    }
  })
  userNameIn.value = ''; passwordIn.value = ''
}

logOut = ()=>{ // signs out for current device
  AWS.config.credentials.clearCachedId()
  cognitoUser.signOut()
  textarea.innerHTML = cognitoUser.username+' - Succesfully logged out.'
  loggedIn.style.display = 'none'; noLogIn.style.display = ''; user.innerHTML = ''
}

logOutAll = ()=>{ // signs out of ALL devices!
  cognitoUser.globalSignOut({
    onSuccess: function (result) {
      textarea.innerHTML = 'Succesfully log out of ALL devices.'
      loggedIn.style.display = 'none'; noLogIn.style.display = ''; user.innerHTML = ''
    },
    onFailure: function(err) { console.log(err) },
  })
}

forgot = ()=>{
  userData.Username = forgotEmail.value
  cognitoUser = new AWSCognito.CognitoIdentityServiceProvider.CognitoUser(userData)
  cognitoUser.forgotPassword({
    onSuccess: function (result) {
      console.log('call result: ' + result)
      textarea.innerHTML = 'SUCCESS!'
    },
    onFailure: function(err) { console.log(err) },
    inputVerificationCode() {
      const verificationCode = prompt('Please input verification code ' ,'')
      const newPassword = prompt('Enter new password ' ,'')
      cognitoUser.confirmPassword(verificationCode, newPassword, this)
    }
  })
}

getUserAttributes = ()=>{
  cognitoUser.getUserAttributes(function(err, attributes) {
    if (err) { console.log(err); return }
    else {
      cognitoUser.attributes = attributes
      textarea.innerHTML = JSON.stringify(attributes, null, 2) + '\n\n --- \n\n' + JSON.stringify(cognitoUser, null, 2)
    }
  })
}

updateAttributes = ()=>{
  var attributeList = []
  var attribute = {
    Name : 'custom:favoriteColor',
    Value : 'cornflowerblue'
  }
  var attribute = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserAttribute(attribute)
  attributeList.push(attribute)
  cognitoUser.updateAttributes(attributeList, function(err, result) {
    if (err) { alert(err); return }
    getUserAttributes()
  })
}

</script>

<!-- *** NOTES ***

-->
