<!DOCTYPE html>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.100.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.min.js"></script>

<div id='graphContainer' style="height: 600px">
  <canvas id="myChart"></canvas>
</div>
<script>

window.onload = ()=>{
  get_aws_DDB_data()
    .then(x => parseData(x))
    .then(x => buildGraph(x))
    .catch(err => console.log('Promise Error: ', err))
}

get_aws_DDB_data = ()=>{
  return new Promise((res, rej) => {
    var table = 'twitter-users-followers-history'
    var creds = new AWS.CognitoIdentityCredentials({
      IdentityPoolId: 'us-east-1:8073513b-ea81-49a3-aa2f-943f4459f57a',
      RoleArn: 'arn:aws:iam::118070506734:role/Cognito_dynamodbPublicReadUnauth_Role',
    })
    AWS.config.update({ region: 'us-east-1', credentials: creds })
    var ddb = new AWS.DynamoDB({ apiVersion: '2012-10-08' })
    var params = { Key: { "name": "allUsers" }, TableName: table}
    var documentClient = new AWS.DynamoDB.DocumentClient();
    documentClient.get(params, function(err, data) {
      if (err) rej(err);
      else res(data)
    })
  })
}

parseData = (data)=>{
  return new Promise((res, rej) => {
    let xLabel = []
    let users = []
    data.Item.timeline.map( x => {
      xLabel.push(x.time)
      x.users.sort((a,b) =>  a.screen_name < b.screen_name ? -1 : 1 )
      x.users.map( ( y, i ) => {
        if (!users[i]) {
          users[i] = {}
          users[i].label = y.screen_name
          users[i].type = 'line'
          users[i].data = []
        }
        users[i].data.push(y.followers_count)
      })
    })
    users[0].borderColor = 'cornflowerblue'
    users[1].borderColor = 'firebrick'
    users[2].borderColor = 'green'
    res([xLabel, users])
  })
}


buildGraph = (data, [ xLabel, users ] = data )=>{
  const ctx = document.getElementById('myChart').getContext('2d')
  const myChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: xLabel,
      datasets: users
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
       tooltips: {
          callbacks: {
             title: function() {}
          }
       },
    }
  })
}

</script>
</html>
