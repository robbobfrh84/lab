<!doctype html>
<head>
	<meta charset="utf-8">
</head>
<body>
  <p id='graphTitle' style='margin: 5px;'></p>
  <svg id='cont' width="1024" height="400" viewbox'0 0 1024 512' style='background-color: rgba(0,0,0,0.1);'></svg>
  <script src="http://cdn.pubnub.com/pubnub-3.7.15.min.js"></script>
	<script src="http://cdn.rawgit.com/scalabl3/pubnub-flex-history/v1.05/pubnub-flex-history-min.js"></script>
	<script>

//----------Build Proto User Data and Seed Graph------------------------------//
    var svgElement = 'http://www.w3.org/2000/svg';
    var userName = 'robbobfrh84';
    var user_id = '1234!@#$';
    var title = 'My First Temperature Graph';
    var channel = userName;
    var publish = 'pub-c-6d531795-b849-4e94-b216-b518015fa7df';
    var subscribe = 'sub-c-65f59724-23b5-11e6-8bc8-0619f8945a4f';
    var type = 'light';
    var sensor = 'tempF';
    var graphCount = 0;

    var user = {
    	userName: userName,
    	user_id: user_id,
    	graphCount: graphCount,
    	graph: []
    };

    user.graph[user.graphCount] = {
    	title: title, //user input
    	channel: '1a', //channel+'#'+user.graphCount,
      publish: publish,
      subscribe: subscribe,
    	type: type,
    	sensor: sensor
    };

    user.graphCount++;
    graphTitle.innerHTML = user.graph[0].title+'<br><br>';

//--------------------startup PubNub Contact----------------------------------//
  	var hist = PUBNUB.init({
  		publish_key: user.graph[0].publish,
  		subscribe_key: user.graph[0].subscribe
  	});

  	hist.flex_history = pubnub_flex_history;
  	var flex_history_callback = function(result) {
  	  if (!result.error) { console.log(result.operation + " completed", result);
        pointBlks(result);
  	  }
  	  else { console.warn(result.operation + " failed", result); }
  	}

    var dayStart = 1464764400;
    var plotCnt = 0;
		var gap = 90;

    var options = {
      channel: user.graph[0].channel,
      between: [dayStart, dayStart+gap]
    }

    //hist.flex_history(options, flex_history_callback);

		var lightArray = [];
		var tempArray = [];
		var pressArray = [];
		var timeArray = [];

    function pointBlks(blk){
			if (blk.count === 0){
				lightArray = lightArray.concat(null);
				tempArray = tempArray.concat(null);
				pressArray = pressArray.concat(null);
				timeArray = timeArray.concat(null);
			} else {
				for (var i = 0; i < blk.count; i++){
	        lightArray = lightArray.concat(blk.messages[i].message.light);
					tempArray = tempArray.concat(blk.messages[i].message.temp);
					pressArray = pressArray.concat(blk.messages[i].message.press);
					timeArray = timeArray.concat(blk.messages[i].timetoken);
				}
			}
      dayStart+=gap;  plotCnt++;
      options.between = [dayStart, dayStart+gap];
      if (plotCnt < 86400/gap){
				console.log('plotCnt...');
        hist.flex_history(options, flex_history_callback);
      } else {
        under480(lightArray,tempArray,pressArray,timeArray);
			}
    }

		var lData = [];
		var tData = [];
		var pData = [];
		var time = [];

		function under480(l,tp,p,t){
			for (var i = 0; i < 960; i+=2){
				if (l[i] && l[i-1]){
					lData = lData.concat((l[i]+l[i-1])/2);
					tData = tData.concat((tp[i]+tp[i-1])/2);
					pData = pData.concat((p[i]+p[i-1])/2);
					time = time.concat(t[i]);
				}
				else if (l[i] && !l[i-1]){ console.log('No second data point');
		      lData = lData.concat(l[i]);
					tData = tData.concat(tp[i]);
					pData = pData.concat(p[i]);
					time = time.concat(t[i]);
				} else { console.log("No data at this index...");
					lData = lData.concat(null);
					tData = tData.concat(null);
					pData = pData.concat(null);
          time = time.concat(null);
				}
			}
		  console.log(lData);
			console.log(tData);
			console.log(pData);
			console.log(time);
			graphTitle.innerHTML = graphTitle.innerHTML+'<br><br><br>'+
			'var LightR = ['+lData+']; <br>'+
			'var TempR = ['+tData+']; <br>'+
			'var PressR = ['+pData+']; <br>'+
			'var TimeR = ['+time+']; ';
		}

  </script>
	<script src='hardHistory.js'></script>
</body>
</html>
