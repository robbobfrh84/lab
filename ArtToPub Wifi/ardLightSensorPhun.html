<!doctype html>
<head>
	<meta charset="utf-8">
</head>
<body>
	<p id='light' style='margin: 5px;'>Light Sensor: </p>
	<p id='led' style='margin: 5px;'>LED Level: </p>
	<svg id='cont' width="18007" height="512" viewbox'0 0 18007 512'>
		<circle id='circle' cx="515" cy="256" r="3" stroke="red" stroke-width="2" fill="yellow"/>
	</svg>
	<script src="http://cdn.pubnub.com/pubnub-3.7.15.min.js"></script>
	<script src="http://cdn.rawgit.com/scalabl3/pubnub-flex-history/v1.05/pubnub-flex-history-min.js"></script>
	<script>
	var svgElement = 'http://www.w3.org/2000/svg';
  var ardDate;
	var settings = {
		channel: 'test',
		publish_key: 'pub-c-d9caecb5-0430-44ca-b3bc-c40e492ef8b4',
		subscribe_key: 'sub-c-0a33ef98-1ef7-11e6-84f2-02ee2ddab7fe'
	};
	var pubnub = PUBNUB(settings);
  var cnt = 0; var line;

	pubnub.subscribe({
	  channel: 'test',
	  callback: function(m) {
	    ardData = m;

			light.innerHTML = 'Light Sensor: '+ardData.light;
			led.innerHTML = 'LED Level: '+ardData.led;
			divlight.style.width=ardData.light+'px';
			circle.setAttributeNS(null, 'r',ardData.light/4-75);

      var newObj = document.createElementNS(svgElement, 'line');
      newObj.setAttributeNS(null, 'x1', cnt);
      newObj.setAttributeNS(null, 'y1', 512);
      newObj.setAttributeNS(null, 'x2', cnt);
      newObj.setAttributeNS(null, 'y2', 512-(ardData.light/2)+'px');
      newObj.setAttributeNS(null, 'stroke', 'blue');
      newObj.setAttributeNS(null, 'stroke-width', 1);

      document.getElementById('cont').appendChild(newObj);
      cnt++;
	  },
	  error: function(err) {console.log(err);}
	});

	var hist;
	var lightHist = PUBNUB.init({
		publish_key: 'pub-c-d9caecb5-0430-44ca-b3bc-c40e492ef8b4',
		subscribe_key: 'sub-c-0a33ef98-1ef7-11e6-84f2-02ee2ddab7fe'
	});

	lightHist.flex_history = pubnub_flex_history;
	// Example of a generic callback from pubNub ...
	var flex_history_callback = function(result) {
	  if (!result.error) {
	    console.log(result.operation + " completed", result);
	    hist = result;
      console.log(hist);
			plotAll();
	  }
	  else {
	    console.warn(result.operation + " failed", result);
	  }
	}

	var getAll = {
	  channel: 'test',
	  getall: true
	}

	lightHist.flex_history(getAll, flex_history_callback);

	function plotAll(){
		for (var i = 18007; i < hist.count; i++){
			var newObj = document.createElementNS(svgElement, 'line');
			var y = hist.messages[i].timetoken;
			var postTime = new Date(y/1e4);
			newObj.setAttributeNS(null, 'id', postTime);
      newObj.setAttributeNS(null, 'x1', i-18007);
      newObj.setAttributeNS(null, 'y1', 512);
      newObj.setAttributeNS(null, 'x2', i-18007);
      newObj.setAttributeNS(null, 'y2', 512-(hist.messages[i].message.light/2)+'px');
      newObj.setAttributeNS(null, 'stroke', 'firebrick');
      newObj.setAttributeNS(null, 'stroke-width', 1);
      document.getElementById('cont').appendChild(newObj);
		}
	}
	</script>
  <div id='divlight' style="width: 10px; background-color: red;">light!!!</div>
</body>
</html>
