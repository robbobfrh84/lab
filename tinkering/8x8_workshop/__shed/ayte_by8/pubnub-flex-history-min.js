var pubnub_flex_history=function(e,t){function n(e){return e.toString().length<12?(1e7*parseInt(e)).toString():e.toString()}function r(e,t){if(0===e)return!0;if(0===t)return!1;if(e.length===t.length){for(idx in e)if(parseInt(e[idx])<parseInt(t[idx]))return!0;return!1}console.error("timetokens weren't of the same length",e.length,t.length)}function s(e,t){if(0===t)return!0;if(0===e)return!1;if(e.length===t.length){for(idx in e)if(parseInt(e[idx])>parseInt(t[idx]))return!0;return!1}console.error("timetokens weren't of the same length",e.length,t.length)}function o(e,t){e.callback=function(e){t({start:e[1],end:e[2],count:e[0].length,messages:e[0]})},e.error=function(e){t({error:!0,errorObject:e,errorMessage:e.toString()})},l.history(e)}function a(){g.count=e.last-d.count>=100?100:e.last-d.count,o(g,function(n){d.count+=n.count,Array.prototype.push.apply(d.messages,n.messages),(0===d.start||r(n.start,d.start))&&(d.start=n.start),s(n.end,d.end)&&(d.end=n.end),d.count<e.last?(g.end=n.start,a()):t(d)})}function i(){o(g,function(n){d.count+=n.count,Array.prototype.push.apply(d.messages,n.messages),(0===d.start||r(n.start,d.start))&&(d.start=n.start),s(n.end,d.end)&&(d.end=n.end),d.count<e.msgcount?(g.start=n.end,i()):t(d)})}function u(){o(g,function(e){d.count+=e.count,Array.prototype.push.apply(d.messages,e.messages),(0===d.start||r(e.start,d.start))&&(d.start=e.start),s(e.end,d.end)&&(d.end=e.end),100===e.count?(g.start=e.end,u()):t(d)})}function p(){o(g,function(e){d.count+=e.count,Array.prototype.push.apply(d.messages,e.messages),(0===d.start||r(e.start,d.start))&&(d.start=e.start),s(e.end,d.end)&&(d.end=e.end),100===e.count?(g.start=e.end,p()):t(d)})}function c(){o(g,function(e){d.count+=e.count,Array.prototype.push.apply(d.messages,e.messages),(0===d.start||r(e.start,d.start))&&(d.start=e.start),s(e.end,d.end)&&(d.end=e.end),100===e.count?(g.start=e.end,c()):t(d)})}function u(){o(g,function(e){d.count+=e.count,Array.prototype.push.apply(d.messages,e.messages),(0===d.start||r(e.start,d.start))&&(d.start=e.start),s(e.end,d.end)&&(d.end=e.end),100===e.count?(g.start=e.end,u()):t(d)})}var l=this,d={count:0,start:0,end:0,channel:e.channel,messages:[],operation:"undefined",operationValue:"undefined"};if(d.operation=e.hasOwnProperty("last")?"last":d.operation,d.operation=e.hasOwnProperty("since")?"since":d.operation,d.operation=e.hasOwnProperty("before")?"before":d.operation,d.operation=e.hasOwnProperty("upto")?"upto":d.operation,d.operation=e.hasOwnProperty("between")?"between":d.operation,d.operation=e.hasOwnProperty("at")?"at":d.operation,d.operation=e.hasOwnProperty("getrange")?"getrange":d.operation,d.operation=e.hasOwnProperty("getall")?"getall":d.operation,!e.hasOwnProperty("channel"))return console.error("ERROR: pubnub_flex_history requires a channel specified in options object"),d.channel=null,d.error=!0,d.errorMessage="channel not specified",void t(d);var g={channel:e.channel,include_token:!0,string_message_token:!0};if(e.hasOwnProperty("last"))d.operationValue=e.last,g.reverse=!1,parseInt(e.last)<=100&&(g.count=e.last,o(g,function(e){for(var n in e)d[n]=e[n];t(d)})),parseInt(e.last)>100&&a();else if(e.hasOwnProperty("before"))d.operationValue={before:e.before,msgcount:e.msgcount},g.start=n(e.before),g.reverse=!1,parseInt(e.msgcount)<=100&&(g.count=e.msgcount,o(g,function(e){for(var n in e)d[n]=e[n];t(d)})),parseInt(e.msgcount)>100&&(g.count=e.msgcount-d.count>=100?100:e.msgcount-d.count,i());else if(e.hasOwnProperty("since"))d.operationValue=e.since,g.start=n(e.since),g.reverse=!0,u();else if(e.hasOwnProperty("upto"))d.operationValue=e.upto,g.end=n(e.upto),g.reverse=!0,p();else if(e.hasOwnProperty("getrange"))d.operationValue=!0,d.messages={},g.count=1,g.reverse=!1,o(g,function(e){if(d.messages.last=e.messages[0],s(e.end,d.end)){d.end=e.end;var t=e.end/1e7|0,n=new Date(0);n.setUTCSeconds(t),d.endE=t,d.endD=n.toString()}}),g.reverse=!0,o(g,function(e){if(d.messages.first=e.messages[0],0===d.start||r(e.start,d.start)){d.start=e.start;var n=e.start/1e7|0,s=new Date(0);s.setUTCSeconds(n),d.startE=n,d.startD=s.toString();var o=0,a=d.endE-d.startE,i=Math.floor(a/86400);o=a-24*i*60*60;var u=Math.floor(o/3600);o-=60*u*60;var p=Math.floor(o/60);o-=60*p;var c=o;d.duration={total_seconds:a,days:i,hours:u,minutes:p,seconds:c}}d.start>0&&d.end>0&&(delete d.count,t(d))});else if(e.hasOwnProperty("between")){d.operationValue=e.between;var f=n(e.between[0]),h=n(e.between[1]);s(f,h)&&(f=h,h=n(e.between[0])),g.start=f,g.end=h,g.reverse=!0,c()}else e.hasOwnProperty("at")?(d.operationValue=e.at,g.start=n(e.at),g.count=1,o(g,function(e){d.count+=e.count,Array.prototype.push.apply(d.messages,e.messages),e.count>0&&(0===d.start||r(e.start,d.start))&&(d.start=e.start),e.count>0&&s(e.end,d.end)&&(d.end=e.end),t(d)})):e.hasOwnProperty("getall")?(d.operationValue=!0,g.start=n(1262307661),g.reverse=!0,u()):(console.error("ERROR: pubnub_flex_history operation required, one of [last, since, getrange, between, at, getall]"),d.error=!0,d.errorMessage="operation required, one of [last, since, getrange, upto, between, at, getall]",d.errorArgs=e,t(d))};
